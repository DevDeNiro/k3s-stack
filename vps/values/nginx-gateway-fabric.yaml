# =============================================================================
# NGINX Gateway Fabric Configuration (v2.4.1)
# Gateway API implementation using NGINX - optimized for VPS (4-6GB RAM)
# Docs: https://docs.nginx.com/nginx-gateway-fabric/
# 
# Architecture in v2.x:
#   - Control plane: installed via this Helm chart (watches Gateway API resources)
#   - Data plane (NGINX): provisioned dynamically when a Gateway is created
# =============================================================================

# -----------------------------------------------------------------------------
# Control Plane (nginx-gateway-fabric controller)
# -----------------------------------------------------------------------------
nginxGateway:
  # Must be 'deployment' in v2.4.1
  kind: deployment

  # Gateway class configuration
  gatewayClassName: nginx
  gatewayControllerName: gateway.nginx.org/nginx-gateway-controller

  # Logging
  config:
    logging:
      level: info  # debug, info, warn, error

  # Leader election (for HA)
  leaderElection:
    enable: true

  # Control plane resource limits (minimal for VPS)
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  # Control plane replicas
  replicas: 1

  # Metrics for Prometheus
  metrics:
    enable: true
    port: 9113

  # Pod annotations for Prometheus scraping
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9113"
    prometheus.io/path: "/metrics"

  # Tolerations (allow running on control-plane node)
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

# -----------------------------------------------------------------------------
# Data Plane (NGINX instances - provisioned per Gateway)
# -----------------------------------------------------------------------------
nginx:
  # Deployment type for data plane
  kind: deployment

  # Number of NGINX replicas (when not using HPA)
  replicas: 1

  # Container configuration
  container:
    # hostPorts to expose ports 80/443 directly on the node
    # Required because servicelb is disabled in K3s and NodePort range is 30000-32767
    hostPorts:
      - port: 80
        containerPort: 80
      - port: 443
        containerPort: 443

    # Data plane resource limits (minimal for VPS)
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

  # Service configuration for data plane
  service:
    # ClusterIP since we use hostPorts
    type: ClusterIP

  # Tolerations for NGINX pods
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
