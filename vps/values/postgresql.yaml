# =============================================================================
# PostgreSQL Minimal Configuration for VPS (4-6GB RAM)
# Optimized for low memory footprint with production-grade features
# =============================================================================

# Use standalone mode (no replication)
architecture: standalone

auth:
  enablePostgresUser: true
  # Passwords managed via Kubernetes Secret (created by setup-secrets.sh)
  existingSecret: postgresql-secret
  secretKeys:
    adminPasswordKey: postgres-password
    userPasswordKey: password
  database: "appdb"
  username: "appuser"

# TLS/SSL - Auto-generate certificates for in-cluster encryption
# NOTE: When tls.enabled=true, Bitnami handles all SSL config automatically
# Do NOT add ssl settings in primary.configuration - it will conflict
tls:
  enabled: true
  autoGenerated: true  # Bitnami will generate self-signed certs
  preferServerCiphers: true
  # For production with custom certs, use:
  # certificatesSecret: postgresql-tls-secret
  # certFilename: tls.crt
  # certKeyFilename: tls.key

# Primary PostgreSQL configuration
primary:
  # Resource limits optimized for 4GB VPS
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "384Mi"
      cpu: "500m"

  persistence:
    enabled: true
    size: "10Gi"
    storageClass: ""
    accessModes:
      - ReadWriteOnce

  # Extended PostgreSQL configuration (ADDED to default config, not replacing)
  # NOTE: Do NOT use 'configuration' - it replaces the entire config and breaks TLS
  extendedConfiguration: |
    # ===========================================
    # Memory Configuration (optimized for 384MB limit)
    # ===========================================
    shared_buffers = 96MB
    effective_cache_size = 192MB
    work_mem = 4MB
    maintenance_work_mem = 32MB
    max_connections = 50
    
    # ===========================================
    # WAL & Archiving (for point-in-time recovery)
    # ===========================================
    wal_level = replica
    archive_mode = on
    archive_command = 'test ! -f /bitnami/postgresql/wal_archive/%f && cp %p /bitnami/postgresql/wal_archive/%f'
    archive_timeout = 300
    max_wal_senders = 3
    wal_keep_size = 256MB
    
    # ===========================================
    # pg_stat_statements (slow query monitoring)
    # ===========================================
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all
    pg_stat_statements.max = 5000
    pg_stat_statements.track_utility = on
    pg_stat_statements.track_planning = on
    
    # ===========================================
    # Logging (slow queries > 500ms)
    # ===========================================
    log_min_duration_statement = 500
    log_statement = 'ddl'
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_checkpoints = on
    log_lock_waits = on
    log_temp_files = 0
    
    # ===========================================
    # Performance Tuning
    # ===========================================
    random_page_cost = 1.1
    effective_io_concurrency = 200
    checkpoint_completion_target = 0.9
    
    # ===========================================
    # Autovacuum (conservative for low memory)
    # ===========================================
    autovacuum_max_workers = 2
    autovacuum_naptime = 60s

  # pg_hba.conf - Let Bitnami handle it when TLS is enabled
  # It will automatically configure hostssl for remote connections
  # Only uncomment if you need custom rules:
  # pgHbaConfiguration: |
  #   local all all scram-sha-256
  #   hostssl all all 0.0.0.0/0 scram-sha-256

  # Init scripts to setup pg_stat_statements extension
  initdb:
    scripts:
      init-extensions.sql: |
        -- Enable pg_stat_statements extension
        CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
        
        -- Grant access to app user
        GRANT pg_read_all_stats TO appuser;

  # Extra volume for WAL archive
  extraVolumes:
    - name: wal-archive
      emptyDir:
        sizeLimit: 1Gi

  extraVolumeMounts:
    - name: wal-archive
      mountPath: /bitnami/postgresql/wal_archive

# Service configuration
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# Metrics and monitoring
metrics:
  enabled: true
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "64Mi"
      cpu: "100m"
  service:
    type: ClusterIP
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9187"
  serviceMonitor:
    enabled: false

# Security context
containerSecurityContext:
  enabled: true
  runAsUser: 1001
  runAsNonRoot: true
  allowPrivilegeEscalation: false

podSecurityContext:
  enabled: true
  fsGroup: 1001

# Pod labels
podLabels:
  app: postgresql
  component: database
  environment: vps

# Liveness/Readiness probes
livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

readinessProbe:
  enabled: true
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
